{% extends 'core/base.html' %}

{% block title %}Create Order - School Management System{% endblock %}

{% block content %}
<!-- Optional: Bootstrap Icons (nice little touches for labels) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  /* Page polish */
  .page-wrap {
    background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 1rem;
    border: 1px solid #eef2f7;
  }
  .section-title {
    font-weight: 700;
    letter-spacing: .2px;
  }
  .helper {
    font-size: .85rem;
    color: #64748b;
  }
  .badge-mode {
    font-weight: 600;
    letter-spacing: .3px;
  }
  .summary-card {
    position: sticky;
    top: 1rem;
  }
  .form-label .bi {
    opacity: .7;
    margin-right: .35rem;
  }
  .required::after {
    content: " *";
    color: #dc3545;
    font-weight: 600;
  }
</style>

<div class="container my-4">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1">
        {% if is_edit %}Edit Order{% else %}Create New Order{% endif %}
      </h2>
      <div class="text-muted">Manage customer order details and payments.</div>
    </div>
    <span class="badge bg-{% if is_edit %}warning{% else %}primary{% endif %} badge-mode">
      {% if is_edit %}<i class="bi bi-pencil-square me-1"></i>Editing{% else %}<i class="bi bi-plus-circle me-1"></i>Creating{% endif %}
    </span>
  </div>

  <div class="page-wrap p-3 p-md-4">
    <div class="row g-4">
      <!-- Left: Form -->
      <div class="col-lg-8">
        <div class="card shadow-sm border-0">
          <div class="card-body p-3 p-md-4">
            <form method="post" id="orderForm"
                  action="{% if is_edit %}{% url 'edit_order' order.id %}{% else %}{% url 'create_orders' %}{% endif %}">
              {% csrf_token %}

              <!-- Basics -->
              <h5 class="section-title mb-3"><i class="bi bi-box-seam me-2"></i>Order Details</h5>
              <div class="row g-3">
                <!-- Order Date and CNIC Side by Side -->
                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-calendar3"></i>Order Date</label>
                  <input type="date" name="order_date" class="form-control" required
                         value="{% if is_edit and order.order_date %}{{ order.order_date|date:'Y-m-d' }}{% endif %}">
                  <div class="helper mt-1">Select the date when the order was placed.</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-person-vcard"></i>CNIC</label>
                  <input type="text" name="cnic" class="form-control" placeholder="CNIC" required
                         value="{% if is_edit %}{{ order.cnic_number }}{% endif %}">
                </div>

                <!-- Customer Name -->
                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-person-badge"></i>Customer Name</label>
                  <input type="text" name="customer_name" class="form-control" placeholder="e.g., Ahmed Khan" required
                         value="{% if is_edit %}{{ order.customer_name }}{% endif %}">
                </div>

                <!-- Address -->
                <div class="col-12">
                  <label class="form-label required"><i class="bi bi-geo-alt"></i>Address</label>
                  <textarea name="address" class="form-control" rows="2" placeholder="Street, City, Postal Code" required>{% if is_edit %}{{ order.address }}{% endif %}</textarea>
                </div>

                <!-- Email -->
                <div class="col-md-6">
                  <label class="form-label"><i class="bi bi-envelope"></i>Email (optional)</label>
                  <input type="email" name="email" class="form-control" placeholder="example@example.com"
                         value="{% if is_edit %}{{ order.email }}{% endif %}">
                </div>

                <!-- Phone Number -->
                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-telephone"></i>Phone Number</label>
                  <div class="input-group">
                    <span class="input-group-text">+92</span>
                    <input type="text" name="phone_number" class="form-control" placeholder="3XXXXXXXXX" required
                           value="{% if is_edit %}{{ order.phone_number }}{% endif %}">
                  </div>
                </div>

                <!-- Location -->
                <div class="col-md-6">
                  <label class="form-label"><i class="bi bi-pin-map"></i>Location</label>
                  <input type="text" name="location" class="form-control" placeholder="Campus / Area"
                         value="{% if is_edit %}{{ order.location }}{% endif %}">
                </div>

                <!-- Delivery Date -->
                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-calendar3"></i>Delivery Date</label>
                  <input type="date" name="delivery_date" class="form-control" required
                         value="{% if is_edit and order.delivery_date %}{{ order.delivery_date|date:'Y-m-d' }}{% endif %}">
                </div>
              </div>

              <hr class="my-4">

              <!-- Items -->
              <h5 class="section-title mb-3"><i class="bi bi-bag-plus me-2"></i>Items</h5>
              <div class="row g-3 align-items-end">
                <div class="col-md-7">
                  <label class="form-label required"><i class="bi bi-box"></i>Select Item</label>
                  <select class="form-select" id="itemSelect">
                    <option value="">-- choose stock item --</option>
                    {% for s in stock_items %}
                      <option value="{{ s.id }}" data-name="{{ s.name }}" data-avail="{{ s.quantity }}">{{ s.name }} (avail: {{ s.quantity }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label required"><i class="bi bi-123"></i>Quantity</label>
                  <input type="number" id="itemQty" class="form-control" min="1" value="1">
                </div>
                <div class="col-md-2">
                  <button type="button" id="addItemBtn" class="btn btn-outline-primary w-100"><i class="bi bi-plus-circle"></i> Add</button>
                </div>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-bordered align-middle" id="itemsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:55%">Item</th>
                      <th style="width:20%">Qty</th>
                      <th style="width:25%">Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <hr class="my-4">

              <!-- Payments -->
              <h5 class="section-title mb-3"><i class="bi bi-cash-coin me-2"></i>Payment</h5>
              <div class="row g-3">
                <!-- Total Amount -->
                <div class="col-md-6">
                  <label class="form-label required"><i class="bi bi-currency-dollar"></i>Total Amount</label>
                  <div class="input-group">
                    <span class="input-group-text">PKR</span>
                    <input type="number" step="0.01" min="0" name="total_amount" class="form-control" placeholder="0.00" required
                           value="{% if is_edit %}{{ order.total_amount }}{% endif %}">
                  </div>
                  <div class="helper mt-1">Grand total to be collected.</div>
                </div>

                <!-- Received Amount -->
                <div class="col-md-6">
                  <label class="form-label"><i class="bi bi-wallet2"></i>Received Amount</label>
                  <div class="input-group">
                    <span class="input-group-text">PKR</span>
                    <input type="number" step="0.01" min="0" name="received_amount" class="form-control" placeholder="0.00"
                           value="{% if is_edit %}{{ order.received_amount }}{% else %}0{% endif %}">
                  </div>
                  <div class="helper mt-1">Amount received at the time of order.</div>
                </div>
              </div>

              <!-- Actions -->
              <div class="d-flex align-items-center gap-2 mt-4">
                <button type="submit" class="btn btn-{% if is_edit %}warning{% else %}primary{% endif %}">
                  {% if is_edit %}<i class="bi bi-save2 me-1"></i>Update Order{% else %}<i class="bi bi-check2-circle me-1"></i>Create Order{% endif %}
                </button>
                <a href="{% url 'list_orders' %}" class="btn btn-light border">
                  <i class="bi bi-x-circle me-1"></i>Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: Summary -->
      <div class="col-lg-4">
        <div class="card shadow-sm border-0 summary-card">
          <div class="card-body">
            <h6 class="mb-3 text-muted"><i class="bi bi-receipt me-2"></i>Order Summary</h6>
            <div class="d-flex justify-content-between py-2 border-bottom">
              <span>Total Amount</span>
              <strong id="sumTotal">PKR 0.00</strong>
            </div>
            <div class="d-flex justify-content-between py-2 border-bottom">
              <span>Received</span>
              <strong id="sumReceived">PKR 0.00</strong>
            </div>
            <div class="d-flex justify-content-between py-2">
              <span>Amount Due</span>
              <strong id="sumDue" class="text-danger">PKR 0.00</strong>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              <i class="bi bi-lightbulb"></i>
              <span class="ms-1">Amounts update live as you type.</span>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /row -->
  </div> <!-- /page-wrap -->
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  (function () {
    const form = document.getElementById("orderForm");
    const isEdit = {% if is_edit %}true{% else %}false{% endif %};

    // Live summary calc
    const fmt = (n) => 'PKR ' + (isNaN(n) ? '0.00' : Number(n).toFixed(2));
    const $ = (sel) => document.querySelector(sel);

    const totalInput = form.querySelector('input[name="total_amount"]');
    const recvInput  = form.querySelector('input[name="received_amount"]');
    const sumTotal   = $("#sumTotal");
    const sumRecv    = $("#sumReceived");
    const sumDue     = $("#sumDue");

    function recalc() {
      const t = parseFloat(totalInput.value) || 0;
      const r = parseFloat(recvInput.value) || 0;
      const d = Math.max(t - r, 0);
      sumTotal.textContent = fmt(t);
      sumRecv.textContent  = fmt(r);
      sumDue.textContent   = fmt(d);
      sumDue.classList.toggle('text-danger', d > 0);
      sumDue.classList.toggle('text-success', d === 0 && (t > 0 || r > 0));
    }

    ["input", "change"].forEach(evt => {
      totalInput.addEventListener(evt, recalc);
      recvInput.addEventListener(evt, recalc);
    });
    recalc();

    // ---- Items UI ----
    const itemSelect = document.getElementById('itemSelect');
    const itemQty = document.getElementById('itemQty');
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTbody = document.querySelector('#itemsTable tbody');

    function addRow(id, name, qty, avail){
      // if already exists, increase qty
      const existing = itemsTbody.querySelector(`tr[data-id="${id}"]`);
      if(existing){
        const qtyInput = existing.querySelector('input[name="quantities[]"]');
        qtyInput.value = parseInt(qtyInput.value||'0') + qty;
        existing.querySelector('.qty-label').textContent = qtyInput.value;
        return;
      }
      const tr = document.createElement('tr');
      tr.dataset.id = id;
      tr.dataset.avail = String(avail||'');
      tr.innerHTML = `
        <td>
          ${name} <small class="text-muted">(avail: ${avail ?? ''})</small>
          <input type="hidden" name="item_ids[]" value="${id}">
        </td>
        <td>
          <span class="qty-label">${qty}</span>
          <input type="hidden" name="quantities[]" value="${qty}">
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger remove">Remove</button>
        </td>
      `;
      itemsTbody.appendChild(tr);
    }

    addItemBtn?.addEventListener('click', () => {
      const opt = itemSelect.options[itemSelect.selectedIndex];
      const id = itemSelect.value;
      const name = opt?.dataset?.name;
      const avail = parseInt(opt?.dataset?.avail||'0');
      const qty = parseInt(itemQty.value||'0');
      if(!id){ Swal.fire({icon:'warning', title:'Select an item first'}); return; }
      if(qty<=0){ Swal.fire({icon:'warning', title:'Quantity must be > 0'}); return; }
      if(avail && qty>avail){
        Swal.fire({icon:'error', title:'Insufficient stock', text:`Available: ${avail}`});
        return;
      }
      addRow(id, name, qty, avail);
    });

    itemsTbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('.remove');
      if(!btn) return;
      btn.closest('tr')?.remove();
    });

    // Basic client checks before SweetAlert
    function validate() {
      const t = parseFloat(totalInput.value) || 0;
      const r = parseFloat(recvInput.value) || 0;
      if (t < 0 || r < 0) {
        Swal.fire({ icon: 'error', title: 'Invalid amount', text: 'Amounts cannot be negative.' });
        return false;
      }
      if (r > t) {
        return confirmOverPayment();
      }
      return true;
    }

    function confirmOverPayment() {
      return Swal.fire({
        title: 'Received exceeds Total',
        text: 'Received amount is greater than total. Continue anyway?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, continue',
        cancelButtonText: 'Fix amounts'
      }).then(res => res.isConfirmed);
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // Basic HTML5 validity
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Extra checks
      // validate items vs available stock
      const insufficient = [];
      for(const tr of itemsTbody.children){
        const qty = parseInt(tr.querySelector('input[name="quantities[]"]').value||'0');
        const avail = parseInt(tr.dataset.avail||'0');
        const name = tr.querySelector('td').textContent.trim();
        if(avail && qty>avail){
          insufficient.push(`${name} (need ${qty}, avail ${avail})`);
        }
      }
      if(insufficient.length){
        Swal.fire({
          icon: 'error',
          title: 'Insufficient stock',
          html: '<div style="text-align:left">' + insufficient.map(s=>`- ${s}`).join('<br>') + '</div>'
        });
        return;
      }
      if(itemsTbody.children.length === 0){
        Swal.fire({ icon: 'error', title: 'No items', text: 'Add at least one item.' });
        return;
      }
      if (!(await validate())) return;

      const title = isEdit ? 'Save changes to this order?' : 'Do you want to confirm the order?';
      const text  = isEdit ? 'Please confirm you want to update this order.' : 'Please confirm that you want to create this order.';
      const confirmText = isEdit ? 'Yes, update' : 'Yes, create';
      const successTitle = isEdit ? '✅ Order updated!' : '🎉 Order created!';
      const successText  = isEdit ? 'The order was successfully updated.' : 'The order was successfully created!';

      Swal.fire({
        title, text, icon: 'question',
        showCancelButton: true,
        confirmButtonText: confirmText,
        cancelButtonText: 'No, go back',
        reverseButtons: true,
        focusCancel: true
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: successTitle,
            text: successText,
            icon: 'success',
            timer: 1600,
            showConfirmButton: false,
            willClose: () => form.submit()
          });
        }
      });
    });
  })();
</script>

{% endblock %}
