{% extends 'core/base.html' %}
{% block title %}{% if is_edit %}Edit Quote{% else %}Create Quote{% endif %}{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-1">{% if is_edit %}Edit Quote{% else %}Create Quote{% endif %}</h2>
    <div class="text-muted">Build a proposal with menu items and pricing.</div>
  </div>
  <a class="btn btn-light border" href="{% url 'quote_list' %}"><i class="bi bi-arrow-left"></i> Back to quotes</a>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" id="quoteForm">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Event</label>
          {{ form.event }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Title</label>
          {{ form.title }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Status</label>
          {{ form.status }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Valid Until</label>
          {{ form.valid_until }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Discount %</label>
          {{ form.discount_pct }}
        </div>
        <div class="col-12">
          <label class="form-label">Notes</label>
          {{ form.notes }}
        </div>
      </div>

      <hr class="my-4">
      <h5 class="mb-3">Line Items</h5>
      {{ formset.management_form }}
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="itemsTable">
          <thead class="table-light">
            <tr>
              <th>Menu Item</th>
              <th>Description</th>
              <th>Qty/Portions</th>
              <th>Unit Price</th>
              <th>Line Total</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody>
            {% for f in formset %}
              <tr>
                <td>{{ f.menu_item }}</td>
                <td>{{ f.description }}</td>
                <td>{{ f.quantity }}</td>
                <td>{{ f.unit_price }}</td>
                <td class="line-total"></td>
                <td>
                  {% if f.instance.pk %}
                    {{ f.DELETE }} <span class="text-danger small">Delete</span>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-outline-danger remove-row">Remove</button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex align-items-center gap-2">
        <button type="button" id="addRow" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-circle"></i> Add Row</button>
      </div>

      <div class="mt-4 d-flex align-items-center gap-2">
        <button type="submit" class="btn btn-primary">
          {% if is_edit %}<i class="bi bi-save2"></i> Update Quote{% else %}<i class="bi bi-plus-circle"></i> Create Quote{% endif %}
        </button>
        <a href="{% url 'quote_list' %}" class="btn btn-light border">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('quoteForm');
  const tableBody = document.querySelector('#itemsTable tbody');
  const addBtn = document.getElementById('addRow');
  const totalForms = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');
  const emptyIndex = () => parseInt(totalForms.value, 10);

  function updateLineTotals(){
    tableBody.querySelectorAll('tr').forEach(row => {
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const qty = parseFloat(qtyInput?.value || '0');
      const price = parseFloat(priceInput?.value || '0');
      const total = (qty * price) || 0;
      const cell = row.querySelector('.line-total');
      if(cell){ cell.textContent = 'PKR ' + total.toFixed(2); }
    });
  }

  function addRow(){
    const idx = emptyIndex();
    const tmpl = `
      <tr>
        <td><select name="{{ formset.prefix }}-${idx}-menu_item" class="form-control"></select></td>
        <td><input type="text" name="{{ formset.prefix }}-${idx}-description" class="form-control"></td>
        <td><input type="number" name="{{ formset.prefix }}-${idx}-quantity" class="form-control" value="1" min="1"></td>
        <td><input type="number" step="0.01" name="{{ formset.prefix }}-${idx}-unit_price" class="form-control" value="0.00"></td>
        <td class="line-total"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">Remove</button></td>
      </tr>`;
    tableBody.insertAdjacentHTML('beforeend', tmpl);
    totalForms.value = idx + 1;
    updateLineTotals();
  }

  addBtn?.addEventListener('click', addRow);
  tableBody.addEventListener('input', updateLineTotals);
  tableBody.addEventListener('click', (e)=>{
    if(e.target.closest('.remove-row')){
      e.target.closest('tr').remove();
      updateLineTotals();
    }
  });
  updateLineTotals();
})();
</script>
{% endblock %}
