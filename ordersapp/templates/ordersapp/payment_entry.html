{% extends "core/base.html" %}
{% block title %}Payment Entry{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* ===== Header shimmer ===== */
  .title-wrap{
    display:flex; align-items:center; gap:.6rem;
    background: linear-gradient(90deg,#f8fafc, #eef2ff, #f8fafc);
    background-size: 200% 100%; animation: shimmer 4s ease infinite;
    padding: .9rem 1rem; border-radius: .8rem; margin-bottom: 1rem;
  }
  @keyframes shimmer{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

  /* ===== Stats cards ===== */
  .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap: .8rem; margin-bottom: 1rem; }
  .stat{
    border-radius: .9rem; padding: .9rem 1rem; background:#fff;
    box-shadow: 0 8px 20px rgba(0,0,0,.06);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .stat:hover{ transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,.10); }
  .stat .k{ font-size: .8rem; color:#6b7280; }
  .stat .v{ font-weight:700; font-size: 1.1rem; }
  .stat.total { border-left: 5px solid #6366f1; }
  .stat.rece  { border-left: 5px solid #22c55e; }
  .stat.due   { border-left: 5px solid #ef4444; }

  /* ===== Card polish ===== */
  .fx-card {
    border-radius: 1rem; overflow: hidden;
    box-shadow: 0 10px 28px rgba(0,0,0,.08);
    border: 1px solid #eef2f7;
  }
  .fx-card .fx-head {
    padding: 1rem 1.2rem;
    background: linear-gradient(180deg,#ffffff,#f8fafc);
    border-bottom: 1px solid #eef2f7;
  }
  .fx-card .fx-body { padding: 1.2rem; }

  /* Inputs focus glow */
  .form-control, .form-select, textarea {
    transition: box-shadow .15s ease, border-color .15s ease, transform .12s ease;
  }
  .form-control:focus, .form-select:focus, textarea:focus {
    box-shadow: 0 0 0 .2rem rgba(99,102,241,.15);
    border-color: #6366f1;
  }

  /* Save button micro-anim */
  .btn-commit {
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn-commit:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(34,197,94,.25);
  }

  @media (max-width: 768px){
    .stats{ grid-template-columns: 1fr; }
  }
</style>

<div class="container mt-4">
  <div class="title-wrap">
    <i class="bi bi-cash-coin fs-4 text-success"></i>
    <div>
      <h2 class="m-0">Payment Entry for Order #{{ order.id }}</h2>
      <div class="text-muted small">Customer: <strong>{{ order.customer_name }}</strong></div>
    </div>
  </div>

  <!-- Top stats -->
  <div class="stats">
    <div class="stat total">
      <div class="k">Order Total</div>
      <div class="v">PKR {{ order.total_amount }}</div>
    </div>
    <div class="stat rece">
      <div class="k">Received so far</div>
      <div class="v" id="receivedSoFar">PKR {{ order.received_amount }}</div>
    </div>
    <div class="stat due">
      <div class="k">Amount Due</div>
      <div class="v" id="dueNow">PKR {{ order.due_amount }}</div>
    </div>
  </div>

  <div class="fx-card">
    <div class="fx-head d-flex align-items-center justify-content-between">
      <div class="fw-semibold"><i class="bi bi-receipt-cutoff me-1"></i> Add a Payment</div>
      <span class="badge bg-light text-dark border">Order {{ order.id }}</span>
    </div>
    <div class="fx-body">
      <form method="post" id="paymentForm">
        {% csrf_token %}

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Payment Amount</label>
            <div class="input-group">
              <span class="input-group-text">PKR</span>
              <input type="number" step="0.01" min="0" class="form-control" name="amount" id="amount" placeholder="0.00" required>
            </div>
            <div class="form-text" id="amountHelp">You can’t exceed the remaining due.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Payment Date</label>
            <input type="date" class="form-control" name="payment_date" id="payment_date" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Payment Method</label>
            <select name="payment_method" class="form-select" id="payment_method" required>
              <option value="">-- Select --</option>
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="Bank">Bank Transfer</option>
            </select>
          </div>

          <!-- Conditional fields -->
          <div class="col-md-6 d-none" id="field_card">
            <label class="form-label">Card Reference (last 4 / txn id)</label>
            <input type="text" class="form-control" name="card_ref" placeholder="e.g. **** 1234 or POS-AB12">
          </div>

          <div class="col-md-6 d-none" id="field_bank">
            <label class="form-label">Bank Txn / Ref No.</label>
            <input type="text" class="form-control" name="bank_ref" placeholder="e.g. HBL-TRX-00921">
          </div>

          <div class="col-12">
            <label class="form-label">Notes (optional)</label>
            <textarea class="form-control" name="notes" rows="2" placeholder="Any extra info…"></textarea>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-success btn-commit">
            <i class="bi bi-check2-circle me-1"></i> Save Payment
          </button>
          <a href="{% url 'list_orders' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Orders
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  // Server values for live math
  const total      = parseFloat('{{ order.total_amount|floatformat:2 }}'.replace(/,/g,'')) || 0;
  const receivedSF = parseFloat('{{ order.received_amount|floatformat:2 }}'.replace(/,/g,'')) || 0;
  const dueInitial = Math.max(total - receivedSF, 0);

  const amountInput = document.getElementById('amount');
  const dueEl       = document.getElementById('dueNow');
  const recEl       = document.getElementById('receivedSoFar');
  const methodSel   = document.getElementById('payment_method');
  const fieldCard   = document.getElementById('field_card');
  const fieldBank   = document.getElementById('field_bank');
  const paymentDate = document.getElementById('payment_date');

  // Prefill date = today
  (function setToday(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da= String(d.getDate()).padStart(2,'0');
    paymentDate.value = `${y}-${m}-${da}`;
  })();

  function formatPKR(n){
    const num = isFinite(n) ? n : 0;
    return 'PKR ' + num.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function clamp(val, min, max){ return Math.min(Math.max(val, min), max); }

  // Live update remaining due as user types
  function recompute(){
    let a = parseFloat(amountInput.value) || 0;
    if(a < 0) a = 0;

    // Cap to remaining due
    const remaining = Math.max(total - receivedSF, 0);
    if(a > remaining){ a = remaining; amountInput.value = remaining ? remaining.toFixed(2) : '0.00'; }

    const newReceived = receivedSF + a;
    const newDue = Math.max(total - newReceived, 0);

    recEl.textContent = formatPKR(newReceived);
    dueEl.textContent = formatPKR(newDue);
  }

  amountInput.addEventListener('input', recompute);
  amountInput.addEventListener('blur', recompute);

  // Toggle extra fields by method
  function toggleExtras(){
    const v = methodSel.value;
    fieldCard.classList.toggle('d-none', v !== 'Card');
    fieldBank.classList.toggle('d-none', v !== 'Bank');
  }
  methodSel.addEventListener('change', toggleExtras);

  // SweetAlert confirm before submit
  const form = document.getElementById('paymentForm');
  form.addEventListener('submit', function(e){
    e.preventDefault();

    const amount = parseFloat(amountInput.value) || 0;
    const remaining = Math.max(total - receivedSF, 0);

    if(amount <= 0){
      Swal.fire({icon:'error', title:'Invalid amount', text:'Payment amount must be greater than 0.'});
      return;
    }
    if(amount > remaining + 0.0001){
      Swal.fire({icon:'error', title:'Too much', text:'Amount exceeds remaining due.'});
      return;
    }
    if(!methodSel.value){
      Swal.fire({icon:'warning', title:'Select method', text:'Please select a payment method.'});
      return;
    }

    const newReceived = receivedSF + amount;
    const newDue = Math.max(total - newReceived, 0);

    Swal.fire({
      title: 'Confirm payment?',
      html: `
        <div class="text-start">
          <div><strong>Customer:</strong> {{ order.customer_name|escape }}</div>
          <div><strong>Order Total:</strong> ${formatPKR(total)}</div>
          <div><strong>Received so far:</strong> ${formatPKR(receivedSF)}</div>
          <div><strong>Adding now:</strong> ${formatPKR(amount)}</div>
          <hr class="my-2"/>
          <div><strong>New Received:</strong> ${formatPKR(newReceived)}</div>
          <div><strong>Remaining Due:</strong> ${formatPKR(newDue)}</div>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, save',
      cancelButtonText: 'Cancel',
      reverseButtons: true,
      buttonsStyling: false,
      customClass: {
        popup: 'rounded-4',
        confirmButton: 'btn btn-success',
        cancelButton: 'btn btn-light border ms-2'
      }
    }).then((res) => {
      if(res.isConfirmed){
        // Optional success flash
        Swal.fire({
          title: 'Saving…',
          timer: 700,
          didOpen: () => Swal.showLoading(),
          showConfirmButton: false
        }).then(() => form.submit());
      }
    });
  });

  // Initialize UI
  recompute();
  toggleExtras();
})();
</script>
{% endblock %}
