{% extends 'core/base.html' %}

{% block title %}Customer List - Billing Management Software{% endblock %}

{% block content %}
  <div class="container mt-5">
    <h2 class="text-center mb-4">Customer List</h2>

    {% if messages %}
      <div>
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Customer List Table -->
    <div class="card shadow-lg rounded-3">
      <div class="card-body">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Customer ID</th>
              <th>Name</th>
              <th>Customer Type</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for customer in customers %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ customer.customer_id }}</td>
                <td>{{ customer.name }}</td>
                <td>{{ customer.customer_type }}</td>
                <td>{{ customer.email }}</td>
                <td>{{ customer.phone }}</td>
                <td>{{ customer.address }}</td>
                <td>
                  <!-- Edit Button -->
                  <a href="{% url 'edit_customer' customer.pk %}" class="btn btn-sm btn-primary btn-edit">
                    <i class="fas fa-edit"></i> Edit
                  </a>

                  <!-- Delete Button with Modal Trigger -->
                  <button class="btn btn-sm btn-danger btn-delete" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal" data-customer="{{ customer.pk }}">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="text-center">No customers found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Create New Customer Button -->
    <a href="{% url 'create_customer' %}" class="btn btn-success mt-4 w-100">Create New Customer</a>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this customer? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

<!-- Styling for Edit and Delete Buttons -->
<style>
  .btn-edit, .btn-delete {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 0.5rem;
  }

  .btn-edit:hover, .btn-delete:hover {
    transform: scale(1.05);
    box-shadow: 0 0 12px rgba(0, 123, 255, 0.4);
  }

  .btn-edit {
    background-color: #007bff;
    border-color: #007bff;
  }

  .btn-delete {
    background-color: #dc3545;
    border-color: #dc3545;
  }

  .btn-edit i, .btn-delete i {
    margin-right: 5px;
  }

  .modal-content {
    border-radius: 10px;
    padding: 20px;
  }

  .modal-header {
    background-color: #dc3545;
    color: white;
  }

  .modal-footer .btn-secondary {
    background-color: #e0e0e0;
  }
</style>

<!-- JavaScript for handling Delete Confirmation -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.btn-delete');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let selectedCustomerId = null;

    // Handle Delete Button Click
    deleteButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        selectedCustomerId = this.getAttribute('data-customer');
      });
    });

    // Handle Confirm Deletion
    confirmDeleteBtn.addEventListener('click', function() {
      const url = `/customer/delete/${selectedCustomerId}/`;  // Delete URL for this customer
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'  // Django CSRF token
        },
        body: JSON.stringify({ customer_id: selectedCustomerId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Customer deleted successfully!');
          location.reload();  // Reload the page to show the updated customer list
        } else {
          alert('Error deleting customer. Please try again.');
        }
      })
      .catch(error => {
        alert('There was an error. Please try again later.');
        console.error('Error:', error);
      });
    });
  });
</script>

<!-- Bootstrap JS for Modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome for Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
