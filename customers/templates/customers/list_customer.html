{% extends 'core/base.html' %}

{% block title %}Customer List - Billing Management Software{% endblock %}

{% block content %}
<!-- Required Libraries -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .btn-animated {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .btn-animated:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
  }
</style>

<div class="container mt-5">
  <h2 class="text-center mb-4">
    Customer List
  </h2>

  {% if messages %}
  <div>
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Search Bar -->
  <div class="row mb-4">
    <div class="col-md-6 offset-md-3">
      <form method="GET" action="{% url 'list_customer' %}">
        <div class="input-group">
          <input type="text" class="form-control" name="q" value="{{ request.GET.q }}" placeholder="Search by Name or CNIC" aria-label="Search" />
          <button class="btn btn-outline-secondary" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer List Table -->
  <div class="card shadow-lg rounded-3">
    <div class="card-body">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Customer ID</th>
            <th>Name</th>
            <th>Customer Type</th>
            <th>Email</th>
            <th>Phone</th>
            <th>CNIC</th>
            <th>Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in customers %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ customer.customer_id }}</td>
            <td>{{ customer.name }}</td>
            <td>{{ customer.customer_type }}</td>
            <td>{{ customer.email }}</td>
            <td>{{ customer.phone }}</td>
            <td>{{ customer.cnic }}</td>
            <td>{{ customer.address }}</td>
            <td class="d-flex justify-content-start align-items-center gap-2">
              <!-- Edit Button -->
              <button class="btn btn-sm btn-outline-primary btn-animated btn-edit"
                      data-url="{% url 'edit_customer' customer.pk %}"
                      data-name="{{ customer.name }}">
                <i class="fas fa-edit"></i> Edit
              </button>

              <!-- Delete Button -->
              <form method="POST" action="{% url 'delete_customer' customer.pk %}" class="delete-form d-inline">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-outline-danger btn-animated btn-delete"
                        data-name="{{ customer.name }}">
                  <i class="fas fa-trash-alt"></i> Delete
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center">No customers found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Create New Customer Button -->
  <a href="{% url 'create_customer' %}" class="btn btn-success mt-4 w-100 btn-animated">
    <i class="bi bi-person-plus-fill me-1"></i> Create New Customer
  </a>
</div>

<!-- JavaScript for SweetAlert2 Actions -->
<script>
  // Edit Button Confirmation
  document.querySelectorAll('.btn-edit').forEach(button => {
    button.addEventListener('click', function () {
      const url = this.getAttribute('data-url');
      const name = this.getAttribute('data-name');

      Swal.fire({
        title: `Edit ${name}?`,
        text: "Do you want to edit this customer?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Edit',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#0d6efd',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    });
  });

  // Delete Button Confirmation
  document.querySelectorAll('.btn-delete').forEach(button => {
    button.addEventListener('click', function () {
      const form = this.closest('form');
      const name = this.getAttribute('data-name');

      Swal.fire({
        title: `Delete ${name}?`,
        text: "This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc3545',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });

  // Show Django messages via SweetAlert (if any)
  {% if messages %}
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags }}' === 'success' ? 'success' : 'info',
        title: '{{ message.tags|title }}',
        text: '{{ message }}',
        timer: 6,
        showConfirmButton: false
      });
    {% endfor %}
  {% endif %}
</script>
{% endblock %}
